#!/usr/bin/env bash
#
# harfbuzz_build
# Martin HrubÃ½ (hrubymar10), 2018-2020
#

set -e

HARFBUZZ_VERSION="2.6.8"
SHA256="6648a571a27f186e47094121f0095e1b809e918b3037c630c7f38ffad86e3035"

starttimestamp=$(date +%s)

MY_PATH=$(cd `dirname ${0}` && pwd)
if [ -z "${MY_PATH}" ] ; then
  # error; for some reason, the path is not accessible
  # to the script (e.g. permissions re-evaled after suid)
  echo 'Error: Script path is for some reason not accessible' >&2
  exit 1  # fail
fi
cd "${MY_PATH}/../Sources"

source "${MY_PATH}/env"
source "${MY_PATH}/functions"
unset MACOSX_DEPLOYMENT_TARGET

check_wget
check_xcode
check_meson
check_ninja
check_libffi
check_glib
check_gettext
check_freetype
check_graphite2

rm -rf "harfbuzz-"*
get_src_and_verify_checksum "harfbuzz-${HARFBUZZ_VERSION}.tar.xz" "${SHA256}" "https://github.com/harfbuzz/harfbuzz/releases/download/${HARFBUZZ_VERSION}/harfbuzz-${HARFBUZZ_VERSION}.tar.xz"
tar xf "${MY_PATH}/../Sources/archives/harfbuzz-${HARFBUZZ_VERSION}.tar.xz" -C .
cd "harfbuzz-${HARFBUZZ_VERSION}"
mkdir "build"
meson -Dgraphite=enabled -Dcoretext=enabled --buildtype=release --default-library=shared . "build"
cd "build"
ninja
mkdir "harfbuzz-${HARFBUZZ_VERSION}-RELEASE"
cp "src/libharfbuzz.0.dylib" "harfbuzz-${HARFBUZZ_VERSION}-RELEASE/libharfbuzz.0.dylib"
cd "harfbuzz-${HARFBUZZ_VERSION}-RELEASE"
install_name_tool -id "@rpath/libharfbuzz.0.dylib" "libharfbuzz.0.dylib"
edit_dylib_deps "libharfbuzz.0.dylib"
remove_rpath_if_exists "libharfbuzz.0.dylib" "/usr/local/opt/freetype/lib"
remove_rpath_if_exists "libharfbuzz.0.dylib" "/usr/local/Cellar/graphite2/"
cd "${MY_PATH}/../"
rm -rf "CompiledLibs/harfbuzz-"*
mv "Sources/harfbuzz-${HARFBUZZ_VERSION}/build/harfbuzz-${HARFBUZZ_VERSION}-RELEASE" "CompiledLibs/harfbuzz-${HARFBUZZ_VERSION}-RELEASE"
rm -rf "../lib/libharfbuzz.0.dylib"
cp -rf "CompiledLibs/harfbuzz-${HARFBUZZ_VERSION}-RELEASE/libharfbuzz.0.dylib" "../lib/libharfbuzz.0.dylib"
rm -rf "${MY_PATH}/../../Headers/harfbuzz"
mkdir "${MY_PATH}/../../Headers/harfbuzz"
cd "${MY_PATH}/../Sources/harfbuzz-${HARFBUZZ_VERSION}/src"
cp "hb-blob.h" "hb-buffer.h" "hb-common.h" "hb-deprecated.h" "hb-draw.h" "hb-face.h" "hb-font.h" "hb-map.h" "hb-set.h" "hb-shape-plan.h" "hb-shape.h" "hb-style.h" "hb-unicode.h" "hb-version.h" "hb.h" "${MY_PATH}/../../Headers/harfbuzz/"

echo "==> DONE ..."
echo
time_interval_to_string "${starttimestamp}" "$(date +%s)"
echo